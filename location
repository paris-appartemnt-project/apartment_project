```{r}
library("tm")
library("tidytext")
library("proustr")
library("tidyverse")
```


```{r}
annonces <- read.csv("castorus_description150m2.csv")
annoncesmini<- tolower(annonces$Description)
unwanted_array = list(     'Ž'='Z', 'ž'='z', 'À'='A', 'Á'='A', 'Â'='A', 'Ã'='A', 'Ä'='A', 'Å'='A', 'Æ'='A', 'Ç'='C', 'È'='E', 'É'='E',
                            'Ê'='E', 'Ë'='E', 'Ì'='I', 'Í'='I', 'Î'='I', 'Ï'='I', 'Ñ'='N', 'Ò'='O', 'Ó'='O', 'Ô'='O', 'Õ'='O', 'Ö'='O', 'Ø'='O', 'Ù'='U',
                            'Ú'='U', 'Û'='U', 'Ü'='U', 'Ý'='Y', 'Þ'='B', 'ß'='Ss','á'='a',"à"="a", 'â'='a', 'ã'='a', 'ä'='a', 'å'='a', 'æ'='a', 'ç'='c', 
                         'è'='e', 'é'='e', 'ê'='e', 'ë'='e', 'ì'='i', 'í'='i', 'î'='i', 'ï'='i', 'ð'='o', 'ñ'='n', 'ò'='o', 'ó'='o', 'ô'='o', 'õ'='o',
                            'ö'='o', 'ø'='o', 'ù'='u', 'ú'='u', 'û'='u', 'ý'='y', 'ý'='y', 'þ'='b', 'ÿ'='y' )
cleanannonces <- chartr(paste(names(unwanted_array), collapse=''),
         paste(unwanted_array, collapse=''),
         annoncesmini) %>% removePunctuation()
```


```{r}
roadnames <- read.csv("roadnames.csv")
roadnames <- roadnames[-c(35,4822, 12874, 13057, 17218, 20551, 20597,21831, 23291, 30137, 30640, 30641, 30642, 32100, 33021, 33384, 33842, 34725, 34767, 34913, 34957, 37145, 37525, 37769, 38212,38289, 38721, 38804, 38813, 32689:32698, 26923, 26924, 32616:32618, 17093, 37459, 30167, 32011:32036, 33720, 26108, 18807, 25850, 32614, 36639, 29994, 33291, 38029, 38090, 35951, 38316), ]
roadmini<- tolower(roadnames$name)

cleanroad <- chartr(paste(names(unwanted_array), collapse=''),
         paste(unwanted_array, collapse=''),
         roadmini)
cleanroadf <- data.frame(cleanroad)

stationames <- read.csv("nom_stations.csv")
stationames <- stationames[-c(30), ]
stationmini <- tolower(stationames)
cleanstation <- chartr(paste(names(unwanted_array), collapse=''),
         paste(unwanted_array, collapse=''),
         stationmini)
x <- sapply(cleanroad, function(x) grepl(x, cleanannonces ,ignore.case = F ,perl = F,
      fixed = TRUE, useBytes = FALSE))
extrait <- apply(x, 1, function(i) paste0(names(i)[i], collapse = ","))
ruedescription<- data.frame(extrait)
```







```{r}
num_rue <- str_extract(cleanannonces, "(?!=rue\\s)\\d+\\d+")
ID <- c(1:140)
numberuec <-data.frame(ID,num_rue)
numero_de_rue=apply(numberuec,2,as.numeric)
numero_de_rue[numero_de_rue>500]=NA
numero_de_rue <- data.frame(numero_de_rue)
numero_rue <- numero_de_rue$numberue
numero_rue <- data.frame(numero_rue)

station <- sapply(cleanstation, function(x) grepl(x, cleanannonces ,ignore.case = F ,perl = F,
      fixed = TRUE, useBytes = FALSE))
stationextrait <- apply(station, 1, function(i) paste0(names(i)[i], collapse = ","))
station_nom <- data.frame(stationextrait)

fullextrait <- data.frame( numero_de_rue, ruedescription,  station_nom)
fullextrait
```

```{r}
install.packages("stringr")
library(stringr)
library(dplyr)
library(googleway)
library(geosphere)
```

We are now going to find the location of the appartements using the Google maps API
If we have the full address, we will use the coordinate of the full address but if we do not have the full adress we will une either the nema of the street or the metro station. If we have more than one of these informations we will compute the mean of the location of all the available datas.
```{r}
fullextrait
a <- google_geocode("23 Rue Claude Lorain, Paris", key = "AIzaSyDBIYQwxvUVTn5GumtMtMZhXZtbyw7KPrM")
a$results$geometry$location$lat
a
```


```{r}
#Replace blanks by NAs
fullextrait[fullextrait==""]  <- NA

#Fonction adresse complète
localisation_comp <- function(df){
  if (is.na(df$num_rue) == FALSE & is.na(df$extrait) == FALSE ) {
 loc <- google_geocode(paste0(df$num_rue,df$extrait,", Paris, France"), key = "AIzaSyDBIYQwxvUVTn5GumtMtMZhXZtbyw7KPrM")
 lat <- loc$results$geometry$location$lat
 lon <- loc$results$geometry$location$lng
 coord <<- list(lon,lat)
 return(coord)
  }
}
localisation_comp(fullextrait[6,])

#Fonction rue unique 
localisation_rue <- function(df){
    if(is.na(df$num_rue) & is.na(df$extrait) == FALSE & is.na(df$stationextrait)){
  loc <- google_geocode(paste0(df$extrait,", Paris, France"), key = "AIzaSyDBIYQwxvUVTn5GumtMtMZhXZtbyw7KPrM")
  lat <- loc$results$geometry$location$lat
  lon <- loc$results$geometry$location$lng
  coord <<- list(lon,lat)
 return(coord)
  }
}

localisation_rue(fullextrait[9,])

#Fontion metro 
localisation_metro <- function(df){
    if(is.na(df$num_rue) & is.na(df$extrait) & str_count(df$stationextrait,',')==0){
  loc <- google_geocode(paste0("metro",df$stationextrait,", Paris, France"), key = "AIzaSyDBIYQwxvUVTn5GumtMtMZhXZtbyw7KPrM")
  lat <- loc$results$geometry$location$lat
  lon <- loc$results$geometry$location$lng
  coord <<- list(lon,lat)
 return(coord) 
  }
}

localisation_metro(fullextrait[35,])

  #else{
   # if(is.na(fullextrait$extrait) == FALSE){
     # if(str_count(fullextrait$stationextrait,',') == 0){
       # if(is.na(fullextrait$stationextrait)){
      #loc <- google_geocode(paste0(fullextrait$extrait,", Paris, France"),key = "AIzaSyDBIYQwxvUVTn5GumtMtMZhXZtbyw7KPrM")}
      #  else{loc <- midPoint(google_geocode(paste0(fullextrait$extrait,", Paris, France"),key = "AIzaSyDBIYQwxvUVTn5GumtMtMZhXZtbyw7KPrM"),paste0(fullextrait$stationextrait,", Paris, France"),key = "AIzaSyDBIYQwxvUVTn5GumtMtMZhXZtbyw7KPrM")}
     # if(str_count(fullextrait$stationextrait,',') >0){
     #faire le midpoint des n points}
    #else{regarder combien il y a des stations de metro et faire le point}    
   # }
#  }
#}
#}
#remplacer les trucs par nchar(,)
#loc$results$geometry$location$lat
#loc$results$geometry$location$lng
#is.na(fullextrait$num_rue)
```

```{r}
if(is.na(fullextrait$num_rue) == FALSE & is.na(fullextrait$extrait) == FALSE ) {print("a")}
```
